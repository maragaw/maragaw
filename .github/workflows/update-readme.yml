name: Update README

on:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update README with dynamic content
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Developer quotes for MOTD (author, quote pairs)
            const quotes = [
              { author: "John Johnson", quote: "First, solve the problem. Then, write the code." },
              { author: "Martin Fowler", quote: "Any fool can write code that a computer can understand. Good programmers write code that humans can understand." },
              { author: "Edsger W. Dijkstra", quote: "Simplicity is prerequisite for reliability." },
              { author: "Kent Beck", quote: "Make it work, make it right, make it fast." },
              { author: "Jeff Atwood", quote: "The best code is no code at all." },
              { author: "Cory House", quote: "Code is like humor. When you have to explain it, it's bad." },
              { author: "Harold Abelson", quote: "Programs must be written for people to read, and only incidentally for machines to execute." },
              { author: "Jeff Sickel", quote: "Deleted code is debugged code." },
              { author: "Alan Kay", quote: "The most disastrous thing you can ever learn is your first programming language." },
              { author: "Bill Gates", quote: "Measuring programming progress by lines of code is like measuring aircraft building progress by weight." },
              { author: "Edward V. Berard", quote: "Walking on water and developing software from a specification are easy if both are frozen." },
              { author: "Robert C. Martin", quote: "The only way to go fast, is to go well." },
              { author: "Antoine de Saint-Exupéry", quote: "Perfection is achieved not when there is nothing more to add, but when there is nothing left to take away." },
              { author: "Every Developer", quote: "It works on my machine." },
              { author: "Phil Karlton", quote: "There are only two hard things in Computer Science: cache invalidation and naming things." }
            ];

            // Get current timestamp
            const now = new Date();
            const timestamp = now.toISOString().replace('T', ' ').substring(0, 16);

            // Select random quote based on day (so it changes daily, not every run)
            const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const quoteIndex = dayOfYear % quotes.length;
            const selectedQuote = quotes[quoteIndex];

            // Fetch recent commits across all repos
            let logEntries = [];
            try {
              const { data: events } = await github.rest.activity.listPublicEventsForUser({
                username: 'maragaw',
                per_page: 15
              });

              // Filter for push events and format as log entries
              const pushEvents = events.filter(e => e.type === 'PushEvent');

              for (const event of pushEvents) {
                const repo = event.repo.name.split('/')[1];
                const commits = event.payload.commits || [];
                for (const commit of commits.slice(0, 1)) {
                  let msg = commit.message.split('\n')[0];
                  // Truncate message if too long
                  if (msg.length > 40) {
                    msg = msg.substring(0, 37) + '...';
                  }
                  const time = new Date(event.created_at).toISOString().substring(0, 10);
                  logEntries.push(`[${time}] ${repo}: ${msg}`);
                }
                if (logEntries.length >= 5) break;
              }
            } catch (e) {
              console.log('Could not fetch events:', e.message);
            }

            // Fallback if no activity
            if (logEntries.length === 0) {
              logEntries = ['[awaiting new commits...]'];
            }

            // Read current README
            let readme = fs.readFileSync('README.md', 'utf8');

            // Update LAST LOGIN section
            const lastLoginContent = `<!-- LAST_LOGIN_START -->
\`\`\`
matthew@sys:~$ last -1 matthew
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
LAST LOGIN
  matthew   pts/0   github.com   ${timestamp}
\`\`\`
<!-- LAST_LOGIN_END -->`;

            readme = readme.replace(
              /<!-- LAST_LOGIN_START -->[\s\S]*?<!-- LAST_LOGIN_END -->/,
              lastLoginContent
            );

            // Update MOTD section
            const motdContent = `<!-- MOTD_START -->
\`\`\`
matthew@sys:~$ cat /etc/motd
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
{
  "${selectedQuote.author}": "${selectedQuote.quote}"
}
\`\`\`
<!-- MOTD_END -->`;

            readme = readme.replace(
              /<!-- MOTD_START -->[\s\S]*?<!-- MOTD_END -->/,
              motdContent
            );

            // Update ACTIVITY LOG section
            const activityLogContent = `<!-- ACTIVITY_LOG_START -->
\`\`\`
matthew@sys:~$ tail -5 /var/log/git.log
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
${logEntries.map(e => '  ' + e).join('\n')}
\`\`\`
<!-- ACTIVITY_LOG_END -->`;

            readme = readme.replace(
              /<!-- ACTIVITY_LOG_START -->[\s\S]*?<!-- ACTIVITY_LOG_END -->/,
              activityLogContent
            );

            // Write updated README
            fs.writeFileSync('README.md', readme);

            console.log('README updated successfully');
            console.log('Last login:', timestamp);
            console.log('Quote:', selectedQuote.author, '-', selectedQuote.quote);
            console.log('Activity entries:', logEntries.length);

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update README with latest activity" && git push)
